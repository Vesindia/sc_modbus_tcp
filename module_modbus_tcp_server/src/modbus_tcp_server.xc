// Copyright (c) 2011, XMOS Ltd., All rights reserved
// This software is freely distributable under a derivative of the
// University of Illinois/NCSA Open Source License posted in
// LICENSE.txt and at <http://github.xcore.com/>

/*===========================================================================
 Info
 ----
 
 ===========================================================================*/

/*---------------------------------------------------------------------------
 include files
 ---------------------------------------------------------------------------*/
#include "modbus_tcp_server.h"

#include <xs1.h>
#include <xscope.h>
#include "mbtcp.h"
#include "xtcp_client.h"

/*---------------------------------------------------------------------------
 constants
 ---------------------------------------------------------------------------*/

/*---------------------------------------------------------------------------
 ports and clocks
 ---------------------------------------------------------------------------*/

/*---------------------------------------------------------------------------
 typedefs
 ---------------------------------------------------------------------------*/

/*---------------------------------------------------------------------------
 global variables
 ---------------------------------------------------------------------------*/

/*---------------------------------------------------------------------------
 static variables
 ---------------------------------------------------------------------------*/

/*---------------------------------------------------------------------------
 static prototypes
 ---------------------------------------------------------------------------*/

/*---------------------------------------------------------------------------
 Modbus TCP server
 ---------------------------------------------------------------------------*/
void modbus_tcp_server(chanend c_tcp_svr, chanend c_modbus)
{
  xtcp_connection_t conn;

  xscope_register(0, 0, "", 0, "");
  xscope_config_io(XSCOPE_IO_BASIC);

  modbus_tcp_init(c_tcp_svr);

  // Loop forever processing TCP events
  while(1)
  {
    select
    {
      case xtcp_event(c_tcp_svr, conn):
      {
        modbus_tcp_handle_event(c_tcp_svr, c_modbus, conn);
        break;
      } // case xtcp_event(c_modbus, conn):
    } // select
  } // while(1)
}

/*==========================================================================*/
